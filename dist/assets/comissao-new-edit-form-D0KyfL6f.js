import{r as m,b7 as Pe,a8 as Se,a9 as Ce,V as Ve,y as Ie,z as Ee,O as ne,dS as Te,c5 as E,p as Ae,j as e,F as De,D as ae,B as k,S as l,f as O,N as we,e7 as U,eC as $e,bE as Fe,bD as le,Q as H,T as u,I as B,a1 as Ne,K as T,cd as j,a0 as re,aq as A}from"./index-D82XrlGq.js";import{u as ze}from"./use-comissoes-Z0UnFmVo.js";import{C as _}from"./Card-Bw-3A9ev.js";import{C as Be}from"./CardHeader-BbCWHGKm.js";import{S as Me,a as We,b as Re}from"./Stepper-D0acO4zn.js";function _e(){const[d,D]=m.useState([]),[I,$]=m.useState(!0),[F,y]=m.useState(null),{currentRealEstate:b}=Pe(),M=async()=>{var w,P,S;try{$(!0),y(null),console.log("üîç Buscando produtos...",{currentRealEstate:b});const C=await Se.get(Ce.property.list,{params:b!=null&&b.id?{real_estate_id:b.id}:{}});console.log("üì¶ Resposta da API:",C.data);const W=(((w=C.data)==null?void 0:w.data)||[]).map(s=>({id:s.id,nome:s.name||s.title||s.titulo||"Produto sem nome",name:s.name||s.title||s.titulo,title:s.title||s.titulo,titulo:s.titulo||s.title,type:s.type||s.tipo,tipo:s.tipo||s.type,value:s.value||s.preco,preco:s.preco||s.value,area:s.area,address:s.address,city:s.city,state:s.state,neighborhood:s.neighborhood}));console.log("‚úÖ Produtos mapeados:",W),D(W)}catch(C){console.error("‚ùå Erro ao buscar produtos:",C),y(((S=(P=C.response)==null?void 0:P.data)==null?void 0:S.message)||C.message||"Erro ao carregar produtos"),D([])}finally{$(!1)}};return m.useEffect(()=>{M()},[]),{products:d,loading:I,error:F,refetch:M}}function qe(d){const D=_e();switch(d){case"imovel":return D;default:return{products:[],loading:!1,error:null,refetch:()=>{}}}}const se=["Configura√ß√£o B√°sica","Distribui√ß√£o"],Le=ne({tipo:U(["imobiliaria","corretor_principal","corretor_suporte","coordenador","grupo","captador"]),percentual:le.number().min(.01,"Percentual deve ser maior que 0").max(100,"Percentual n√£o pode ser maior que 100")}),ke=ne({nome:H().min(1,"Nome √© obrigat√≥rio"),descricao:H().optional(),categoriaProduto:U(["imovel","terreno","empreendimento"]),produtoId:H().min(1,"Produto √© obrigat√≥rio"),percentualVenda:le.number().min(.01,"Percentual deve ser maior que 0").max(100,"Percentual n√£o pode ser maior que 100"),participantes:Fe(Le).min(1,"Pelo menos um participante √© obrigat√≥rio"),tipoComissao:$e("total_imobiliaria"),status:U(["ativo","inativo"]).default("ativo")}),ie=[{value:"imobiliaria",label:"Imobili√°ria"},{value:"corretor_principal",label:"Corretor Principal"},{value:"corretor_suporte",label:"Corretor Suporte"},{value:"coordenador",label:"Coordenador"},{value:"grupo",label:"Grupo"},{value:"captador",label:"Captador"}];function Je({currentComissao:d}){const D=Ve(),[I,$]=m.useState(0),[F,y]=m.useState(""),[b,M]=m.useState("imovel"),{products:w,loading:P,error:S}=qe(b),{createComissao:C,updateComissao:G}=ze(),W={nome:(d==null?void 0:d.nome)||"",descricao:(d==null?void 0:d.descricao)||"",categoriaProduto:"imovel",produtoId:"",percentualVenda:0,participantes:[],tipoComissao:"total_imobiliaria",status:"ativo"},s=Ie({resolver:Ee(ke),defaultValues:W,mode:"onChange"}),{watch:c,control:ce,setValue:K,handleSubmit:de,getValues:q,formState:{isSubmitting:L,isValid:Q,isDirty:ue,errors:pe}}=s,{fields:h,append:me,remove:ge}=Te({control:ce,name:"participantes"});m.useEffect(()=>{const o=c((i,{name:r})=>{r&&r.startsWith("participantes.")&&console.log("üîÑ Campo de participante alterado:",{name:r,value:i.participantes})});return()=>o.unsubscribe()},[c]);const f=c("categoriaProduto");m.useEffect(()=>{f&&f!==b&&(M(f),K("produtoId",""))},[f,b,K]);const J=c("nome"),X=c("produtoId"),Y=c("percentualVenda"),Z=m.useMemo(()=>{const o={nome:J,categoriaProduto:f,produtoId:X,percentualVenda:Y},i=o.nome&&o.nome.trim().length>0,r=o.categoriaProduto,n=o.produtoId&&o.produtoId.trim().length>0,p=o.percentualVenda&&o.percentualVenda>0;return i&&r&&n&&p},[J,f,X,Y]),V=m.useMemo(()=>{const o=c("participantes")||[],i=[];for(let r=0;r<h.length;r++){const n=o[r],p=q(`participantes.${r}`),a=n||p;a&&a.tipo&&a.percentual!==void 0&&a.percentual!==null&&String(a.percentual).trim()!==""&&i.push(a)}return console.log("üîç participantesData atualizado:",{watchedData:o,fieldsLength:h.length,dadosCombinados:i,validCount:i.length}),i},[c,h,q]),ee=c("participantes"),x=m.useMemo(()=>{const i=(ee||[]).reduce((r,n)=>{const p=typeof(n==null?void 0:n.percentual)=="number"?n.percentual:parseFloat(n==null?void 0:n.percentual)||0;return r+p},0);return Math.round(i*100)/100},[ee]),N=m.useMemo(()=>{if(console.log("üîç Valida√ß√£o do segundo passo:",{participantesData:V,participantesFields:h,percentualTotal:x,participantesLength:V.length,fieldsLength:h.length}),V.length===0)return console.log("‚ùå Valida√ß√£o falhou: Nenhum participante"),!1;const o=V;console.log("üìã Dados para validar:",o);const i=o.filter((t,v)=>{if(!t)return console.log(`‚ùå Participante ${v+1}: objeto nulo/undefined`),!1;if(!(t.tipo&&typeof t.tipo=="string"&&t.tipo.trim()!==""))return console.log(`‚ùå Participante ${v+1}: tipo inv√°lido`,{tipo:t.tipo,tipoType:typeof t.tipo}),!1;let z=0;if(typeof t.percentual=="number")z=t.percentual;else if(typeof t.percentual=="string"){const te=parseFloat(t.percentual);z=isNaN(te)?0:te}return z>0?(console.log(`‚úÖ Participante ${v+1}: v√°lido`,{tipo:t.tipo,percentual:t.percentual,percentualNumerico:z}),!0):(console.log(`‚ùå Participante ${v+1}: percentual inv√°lido`,{percentual:t.percentual,percentualType:typeof t.percentual,percentualNumerico:z}),!1)}),r=i.length===o.length;if(console.log("üìä Participantes v√°lidos:",{total:o.length,validos:i.length,todosValidos:r,participantesDetalhes:o.map((t,v)=>({index:v+1,tipo:t==null?void 0:t.tipo,percentual:t==null?void 0:t.percentual,tipoType:typeof(t==null?void 0:t.tipo),percentualType:typeof(t==null?void 0:t.percentual)}))}),!r)return console.log("‚ùå Valida√ß√£o falhou: Participantes inv√°lidos"),!1;const n=Math.abs(x-100),p=n<=.1;if(console.log("üíØ Valida√ß√£o percentual:",{percentualTotal:x,margemErro:n,percentualValido:p}),!p)return console.log("‚ùå Valida√ß√£o falhou: Percentual total inv√°lido"),!1;const a=o.map(t=>t==null?void 0:t.tipo).filter(t=>t&&typeof t=="string"&&t.trim()!==""),g=new Set(a),R=a.length===g.size;return console.log("üîÑ Valida√ß√£o tipos:",{tipos:a,tiposUnicos:Array.from(g),semDuplicados:R}),R?(console.log("‚úÖ Valida√ß√£o do segundo passo: APROVADA"),!0):(console.log("‚ùå Valida√ß√£o falhou: Tipos duplicados"),!1)},[V,x,h]),he=()=>{$(o=>o+1)},xe=()=>{$(o=>o-1)},fe=()=>{if(y(""),h.length>=6){y("Limite m√°ximo de 6 participantes atingido.");return}const o=V.map(r=>r==null?void 0:r.tipo).filter(Boolean);if(ie.filter(r=>!o.includes(r.value)).length===0){y("Todos os tipos de participantes j√° foram adicionados. Remova um participante existente para adicionar um novo tipo.");return}me({tipo:"",percentual:0})},ve=de(async o=>{var i,r,n,p;console.log("üöÄ onSubmit chamado com sucesso!"),console.log("üìã Dados do formul√°rio:",o),console.log("üë• Participantes:",o.participantes),console.log("üìä Valida√ß√£o segundo passo:",N);try{console.log("‚è≥ Iniciando salvamento...");const a={nome:o.nome,descricao:o.descricao,tipo:"total_imobiliaria",tipoProduto:o.categoriaProduto,percentualTotal:o.percentualVenda,produtoId:o.produtoId,participantes:o.participantes.map(g=>({tipo:g.tipo,percentual:g.percentual,ativo:!0,fixo:!1,obrigatorio:!1})),status:o.status,realEstateId:"68b1df705757655b21fc5210"};d?(await G(d.id,a),E.success("Comiss√£o atualizada com sucesso!")):(await C(a),E.success("Comiss√£o criada com sucesso!")),console.log("‚úÖ Salvamento conclu√≠do!"),console.log("üîÑ Redirecionando..."),D.push(Ae.dashboard.comissoes.root)}catch(a){if(console.error("‚ùå Erro no salvamento:",a),((i=a.response)==null?void 0:i.status)===422){const g=((n=(r=a.response)==null?void 0:r.data)==null?void 0:n.errors)||{},R=Object.entries(g).map(([t,v])=>{const oe=Array.isArray(v)?v:[v];return`${t}: ${oe.join(", ")}`}).join(`
`);E.error(`Erro de valida√ß√£o:
${R}`)}else((p=a.response)==null?void 0:p.status)===500?E.error("Erro interno do servidor. Tente novamente mais tarde."):a.message?E.error(`Erro: ${a.message}`):E.error("Erro ao salvar comiss√£o. Tente novamente.")}},o=>{console.error("‚ùå Erros de valida√ß√£o do formul√°rio:",o),console.log("üìã Dados atuais do formul√°rio:",q()),console.log("üîç Estado de valida√ß√£o:",{isValid:Q,isSubmitting:L,isDirty:ue,segundoPassoValido:N,participantesData:V});const i=Object.entries(o).map(([r,n])=>`${r}: ${(n==null?void 0:n.message)||"Erro desconhecido"}`).join(", ");E.error(`Erros de valida√ß√£o: ${i}`)}),be=()=>e.jsxs(l,{spacing:4,children:[e.jsxs(k,{children:[e.jsx(u,{variant:"h5",sx:{color:"text.primary",fontWeight:700,mb:1},children:"Configura√ß√£o B√°sica"}),e.jsx(u,{variant:"body2",color:"text.secondary",children:"Defina as informa√ß√µes b√°sicas da regra de comiss√£o"})]}),e.jsx(_,{sx:{p:3},children:e.jsxs(l,{spacing:3,children:[e.jsx(T.Text,{name:"nome",label:"Nome da Regra",placeholder:"Ex: Comiss√£o Apartamentos",required:!0}),e.jsx(T.Text,{name:"descricao",label:"Descri√ß√£o",placeholder:"Descri√ß√£o opcional",multiline:!0,rows:3}),e.jsxs(T.Select,{name:"categoriaProduto",label:"Categoria do Produto",required:!0,children:[e.jsx(j,{value:"imovel",children:"Im√≥vel"}),e.jsx(j,{value:"terreno",children:"Terreno"}),e.jsx(j,{value:"empreendimento",children:"Empreendimento"})]}),e.jsxs(T.Select,{name:"produtoId",label:"Escolha o produto",required:!0,disabled:P,children:[e.jsx(j,{value:"",children:P?"Carregando produtos...":"Selecione um produto"}),!P&&!S&&w.map(o=>e.jsx(j,{value:o.id,children:o.nome},o.id)),!P&&S&&e.jsx(j,{value:"",disabled:!0,children:"Erro ao carregar produtos"}),!P&&!S&&w.length===0&&e.jsx(j,{value:"",disabled:!0,children:"Nenhum produto encontrado"})]}),S&&e.jsx(A,{severity:"error",sx:{mt:1},children:S}),e.jsx(T.Text,{name:"percentualVenda",label:"Percentual sobre Venda",type:"number",required:!0,InputProps:{endAdornment:e.jsx(re,{position:"end",children:"%"})}})]})}),!Z&&e.jsx(A,{severity:"info",children:"Preencha todos os campos obrigat√≥rios para continuar"})]}),je=()=>{var o;return e.jsxs(l,{spacing:4,children:[e.jsxs(k,{children:[e.jsx(u,{variant:"h5",sx:{color:"text.primary",fontWeight:700,mb:1},children:"Distribui√ß√£o de Comiss√µes"}),e.jsx(u,{variant:"body2",color:"text.secondary",children:"Configure como a comiss√£o ser√° distribu√≠da entre os participantes"})]}),e.jsx(_,{sx:{p:3,bgcolor:"background.neutral"},children:e.jsxs(l,{spacing:3,children:[e.jsxs(l,{spacing:1,children:[e.jsx(u,{variant:"subtitle1",sx:{fontWeight:600,color:"text.primary"},children:c("nome")||"Nome da Regra"}),e.jsx(u,{variant:"body2",color:"text.secondary",children:c("descricao")||"Sem descri√ß√£o"})]}),e.jsx(ae,{}),e.jsxs(l,{spacing:2,children:[e.jsxs(l,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(B,{icon:f==="imovel"?"mdi:home":f==="terreno"?"mdi:terrain":"mdi:city",sx:{color:"primary.main"}}),e.jsxs(l,{children:[e.jsx(u,{variant:"body2",sx:{fontWeight:500},children:f==="imovel"?"Im√≥vel":f==="terreno"?"Terreno":"Empreendimento"}),e.jsx(u,{variant:"caption",color:"text.secondary",children:"Categoria do produto"})]})]}),c("produtoId")&&e.jsxs(l,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(B,{icon:"mdi:tag",sx:{color:"info.main"}}),e.jsxs(l,{children:[e.jsx(u,{variant:"body2",sx:{fontWeight:500},children:((o=w.find(i=>i.id===c("produtoId")))==null?void 0:o.nome)||"Produto selecionado"}),e.jsx(u,{variant:"caption",color:"text.secondary",children:"Produto espec√≠fico"})]})]}),e.jsxs(l,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(B,{icon:"mdi:percent",sx:{color:"success.main"}}),e.jsxs(l,{children:[e.jsxs(u,{variant:"body2",sx:{fontWeight:500},children:[c("percentualVenda")||0,"% sobre a venda"]}),e.jsx(u,{variant:"caption",color:"text.secondary",children:"Percentual de comiss√£o"})]})]})]})]})}),e.jsx(l,{spacing:2,children:h.map((i,r)=>{const p=(c("participantes")||[]).map((a,g)=>({tipo:a==null?void 0:a.tipo,index:g})).filter(a=>a.tipo&&a.index!==r).map(a=>a.tipo);return e.jsx(_,{sx:{p:3},children:e.jsxs(l,{spacing:2,children:[e.jsxs(l,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(u,{variant:"subtitle2",children:["Participante ",r+1]}),e.jsx(Ne,{onClick:()=>{ge(r),y("")},color:"error",size:"small",children:e.jsx(B,{icon:"mingcute:delete-2-line"})})]}),e.jsxs(l,{direction:"row",spacing:2,children:[e.jsxs(T.Select,{name:`participantes.${r}.tipo`,label:"Tipo de Participante",sx:{flex:1},children:[e.jsx(j,{value:"",disabled:!0,children:"Selecionar tipo"}),ie.map(a=>{const g=p.includes(a.value);return e.jsxs(j,{value:a.value,disabled:g,children:[a.label,g&&e.jsx(u,{component:"span",variant:"caption",color:"text.secondary",sx:{ml:1},children:"(j√° selecionado)"})]},a.value)})]}),e.jsx(T.Text,{name:`participantes.${r}.percentual`,label:"Percentual",type:"number",sx:{flex:1},InputProps:{endAdornment:e.jsx(re,{position:"end",children:"%"})}})]})]})},i.id)})}),F&&e.jsx(A,{severity:"error",onClose:()=>y(""),children:F}),e.jsx(O,{onClick:fe,variant:"outlined",size:"large",startIcon:e.jsx(B,{icon:"mingcute:add-line"}),sx:{alignSelf:"center"},disabled:h.length>=6,children:"Adicionar Participante"}),h.length>=6&&!F&&e.jsx(A,{severity:"info",children:"Limite m√°ximo de 6 participantes atingido"}),x>100&&e.jsx(A,{severity:"error",children:"O total da distribui√ß√£o n√£o pode exceder 100%"}),x<100&&h.length>0&&e.jsxs(A,{severity:"warning",children:["Faltam ",(100-(typeof x=="number"?x:0)).toFixed(1),"% para completar a distribui√ß√£o"]}),Math.abs(x-100)<=.1&&x>0&&e.jsx(A,{severity:"success",children:"Distribui√ß√£o completa! ‚úì"})]})},ye=o=>{switch(o){case 0:return be();case 1:return je();default:return null}};return e.jsx(De,{methods:s,onSubmit:ve,children:e.jsxs(_,{children:[e.jsx(Be,{title:d?"Editar Comiss√£o":"Nova Comiss√£o",subheader:"Configure as regras de distribui√ß√£o de comiss√£o",sx:{pb:3}}),e.jsx(ae,{}),e.jsxs(k,{sx:{p:3},children:[e.jsx(Me,{activeStep:I,sx:{mb:4},children:se.map(o=>e.jsx(We,{children:e.jsx(Re,{children:o})},o))}),ye(I),e.jsxs(l,{direction:"row",justifyContent:"space-between",sx:{mt:4},children:[e.jsx(O,{disabled:I===0,onClick:xe,variant:"outlined",size:"large",children:"Voltar"}),I===se.length-1?e.jsx(we,{type:"submit",variant:"contained",size:"large",loading:L,disabled:!N,sx:{minWidth:120},onClick:()=>{console.log("üñ±Ô∏è Bot√£o Criar/Atualizar clicado!"),console.log("üîç Estado atual:",{segundoPassoValido:N,isSubmitting:L,activeStep:I,participantesData:V,isValid:Q,errors:pe,percentualTotal:x,botaoHabilitado:N})},children:d?"Atualizar":"Criar"}):e.jsx(O,{onClick:he,variant:"contained",size:"large",disabled:!Z,sx:{minWidth:120},children:"Pr√≥ximo"})]})]})]})})}export{Je as C};

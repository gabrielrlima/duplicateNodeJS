import{r as n,V as Pe,y as Se,z as Ee,O as ae,d$ as Ve,cN as I,p as Ce,j as e,F as Ie,D as ee,B,S as l,f as q,N as Te,ee as k,fm as Ae,bm as De,c3 as se,Q as _,T as p,I as F,a1 as we,K as T,b3 as V,a0 as oe,aq as A}from"./index-cNRh_qft.js";import{u as $e}from"./use-comissoes-DByAcImR.js";import{C as L}from"./Card-C_-31fGp.js";import{C as Ne}from"./CardHeader-CZZHKPlX.js";import{S as Fe,a as ze,b as Le}from"./Stepper-tqzoY8Fq.js";function Me(){const[c,f]=n.useState([]),[m,g]=n.useState(!0),[E,u]=n.useState(null),v=async()=>{try{g(!0),u(null),f([])}catch(h){console.error("Erro ao buscar im√≥veis:",h),u(h.message||"Erro ao carregar im√≥veis"),f([])}finally{g(!1)}};return n.useEffect(()=>{v()},[]),{products:c,loading:m,error:E,refetch:v}}function Re(){const[c,f]=n.useState([]),[m,g]=n.useState(!0),[E,u]=n.useState(null),v=async()=>{try{g(!0),u(null),f([])}catch(h){console.error("Erro ao buscar terrenos:",h),u(h.message||"Erro ao carregar terrenos"),f([])}finally{g(!1)}};return n.useEffect(()=>{v()},[]),{products:c,loading:m,error:E,refetch:v}}function We(){const[c,f]=n.useState([]),[m,g]=n.useState(!0),[E,u]=n.useState(null),v=async()=>{try{g(!0),u(null),f([])}catch(h){console.error("Erro ao buscar empreendimentos:",h),u(h.message||"Erro ao carregar empreendimentos"),f([])}finally{g(!1)}};return n.useEffect(()=>{v()},[]),{products:c,loading:m,error:E,refetch:v}}function Be(c){const f=Me(),m=Re(),g=We();switch(c){case"imovel":return f;case"terreno":return m;case"empreendimento":return g;default:return{products:[],loading:!1,error:null,refetch:()=>{}}}}const te=["Configura√ß√£o B√°sica","Distribui√ß√£o"],qe=ae({tipo:k(["imobiliaria","corretor_principal","corretor_suporte","coordenador","grupo","captador"]),percentual:se.number().min(.01,"Percentual deve ser maior que 0").max(100,"Percentual n√£o pode ser maior que 100")}),_e=ae({nome:_().min(1,"Nome √© obrigat√≥rio"),descricao:_().optional(),categoriaProduto:k(["imovel","terreno","empreendimento"]),produtoId:_().min(1,"Produto √© obrigat√≥rio"),percentualVenda:se.number().min(.01,"Percentual deve ser maior que 0").max(100,"Percentual n√£o pode ser maior que 100"),participantes:De(qe).min(1,"Pelo menos um participante √© obrigat√≥rio"),tipoComissao:Ae("total_imobiliaria"),status:k(["ativo","inativo"]).default("ativo")}),re=[{value:"imobiliaria",label:"Imobili√°ria"},{value:"corretor_principal",label:"Corretor Principal"},{value:"corretor_suporte",label:"Corretor Suporte"},{value:"coordenador",label:"Coordenador"},{value:"grupo",label:"Grupo"},{value:"captador",label:"Captador"}];function Qe({currentComissao:c}){const f=Pe(),[m,g]=n.useState(0),[E,u]=n.useState(""),[v,h]=n.useState("imovel"),{products:M,loading:D,error:w}=Be(v),{createComissao:ie,updateComissao:ne}=$e(),ce={nome:(c==null?void 0:c.nome)||"",descricao:(c==null?void 0:c.descricao)||"",categoriaProduto:"imovel",produtoId:"",percentualVenda:0,participantes:[],tipoComissao:"total_imobiliaria",status:"ativo"},O=Se({resolver:Ee(_e),defaultValues:ce,mode:"onChange"}),{watch:d,control:le,setValue:H,handleSubmit:de,getValues:R,formState:{isSubmitting:W,isValid:U,isDirty:ue,errors:pe}}=O,{fields:j,append:me,remove:ge}=Ve({control:le,name:"participantes"});n.useEffect(()=>{const o=d((s,{name:a})=>{a&&a.startsWith("participantes.")&&console.log("üîÑ Campo de participante alterado:",{name:a,value:s.participantes})});return()=>o.unsubscribe()},[d]);const P=d("categoriaProduto");n.useEffect(()=>{P&&P!==v&&(h(P),H("produtoId",""))},[P,v,H]);const G=d("nome"),K=d("produtoId"),Q=d("percentualVenda"),J=n.useMemo(()=>{const o={nome:G,categoriaProduto:P,produtoId:K,percentualVenda:Q},s=o.nome&&o.nome.trim().length>0,a=o.categoriaProduto,i=o.produtoId&&o.produtoId.trim().length>0,x=o.percentualVenda&&o.percentualVenda>0;return s&&a&&i&&x},[G,P,K,Q]),C=n.useMemo(()=>{const o=d("participantes")||[],s=[];for(let a=0;a<j.length;a++){const i=o[a],x=R(`participantes.${a}`),r=i||x;r&&r.tipo&&r.percentual!==void 0&&r.percentual!==null&&String(r.percentual).trim()!==""&&s.push(r)}return console.log("üîç participantesData atualizado:",{watchedData:o,fieldsLength:j.length,dadosCombinados:s,validCount:s.length}),s},[d,j,R]),X=d("participantes"),y=n.useMemo(()=>{const s=(X||[]).reduce((a,i)=>{const x=typeof(i==null?void 0:i.percentual)=="number"?i.percentual:parseFloat(i==null?void 0:i.percentual)||0;return a+x},0);return Math.round(s*100)/100},[X]),$=n.useMemo(()=>{if(console.log("üîç Valida√ß√£o do segundo passo:",{participantesData:C,participantesFields:j,percentualTotal:y,participantesLength:C.length,fieldsLength:j.length}),C.length===0)return console.log("‚ùå Valida√ß√£o falhou: Nenhum participante"),!1;const o=C;console.log("üìã Dados para validar:",o);const s=o.filter((t,S)=>{if(!t)return console.log(`‚ùå Participante ${S+1}: objeto nulo/undefined`),!1;if(!(t.tipo&&typeof t.tipo=="string"&&t.tipo.trim()!==""))return console.log(`‚ùå Participante ${S+1}: tipo inv√°lido`,{tipo:t.tipo,tipoType:typeof t.tipo}),!1;let N=0;if(typeof t.percentual=="number")N=t.percentual;else if(typeof t.percentual=="string"){const Z=parseFloat(t.percentual);N=isNaN(Z)?0:Z}return N>0?(console.log(`‚úÖ Participante ${S+1}: v√°lido`,{tipo:t.tipo,percentual:t.percentual,percentualNumerico:N}),!0):(console.log(`‚ùå Participante ${S+1}: percentual inv√°lido`,{percentual:t.percentual,percentualType:typeof t.percentual,percentualNumerico:N}),!1)}),a=s.length===o.length;if(console.log("üìä Participantes v√°lidos:",{total:o.length,validos:s.length,todosValidos:a,participantesDetalhes:o.map((t,S)=>({index:S+1,tipo:t==null?void 0:t.tipo,percentual:t==null?void 0:t.percentual,tipoType:typeof(t==null?void 0:t.tipo),percentualType:typeof(t==null?void 0:t.percentual)}))}),!a)return console.log("‚ùå Valida√ß√£o falhou: Participantes inv√°lidos"),!1;const i=Math.abs(y-100),x=i<=.1;if(console.log("üíØ Valida√ß√£o percentual:",{percentualTotal:y,margemErro:i,percentualValido:x}),!x)return console.log("‚ùå Valida√ß√£o falhou: Percentual total inv√°lido"),!1;const r=o.map(t=>t==null?void 0:t.tipo).filter(t=>t&&typeof t=="string"&&t.trim()!==""),b=new Set(r),z=r.length===b.size;return console.log("üîÑ Valida√ß√£o tipos:",{tipos:r,tiposUnicos:Array.from(b),semDuplicados:z}),z?(console.log("‚úÖ Valida√ß√£o do segundo passo: APROVADA"),!0):(console.log("‚ùå Valida√ß√£o falhou: Tipos duplicados"),!1)},[C,y,j]),he=()=>{g(o=>o+1)},xe=()=>{g(o=>o-1)},fe=()=>{if(u(""),j.length>=6){u("Limite m√°ximo de 6 participantes atingido.");return}const o=C.map(a=>a==null?void 0:a.tipo).filter(Boolean);if(re.filter(a=>!o.includes(a.value)).length===0){u("Todos os tipos de participantes j√° foram adicionados. Remova um participante existente para adicionar um novo tipo.");return}me({tipo:"",percentual:0})},ve=de(async o=>{var s,a,i,x;console.log("üöÄ onSubmit chamado com sucesso!"),console.log("üìã Dados do formul√°rio:",o),console.log("üë• Participantes:",o.participantes),console.log("üìä Valida√ß√£o segundo passo:",$);try{console.log("‚è≥ Iniciando salvamento...");const r={nome:o.nome,descricao:o.descricao,tipo:"total_imobiliaria",tipoProduto:o.categoriaProduto,percentualTotal:o.percentualVenda,produtoId:o.produtoId,participantes:o.participantes.map(b=>({tipo:b.tipo,percentual:b.percentual,ativo:!0,fixo:!1,obrigatorio:!1})),status:o.status,realEstateId:"68b1df705757655b21fc5210"};c?(await ne(c.id,r),I.success("Comiss√£o atualizada com sucesso!")):(await ie(r),I.success("Comiss√£o criada com sucesso!")),console.log("‚úÖ Salvamento conclu√≠do!"),console.log("üîÑ Redirecionando..."),f.push(Ce.dashboard.comissoes.root)}catch(r){if(console.error("‚ùå Erro no salvamento:",r),((s=r.response)==null?void 0:s.status)===422){const b=((i=(a=r.response)==null?void 0:a.data)==null?void 0:i.errors)||{},z=Object.entries(b).map(([t,S])=>{const Y=Array.isArray(S)?S:[S];return`${t}: ${Y.join(", ")}`}).join(`
`);I.error(`Erro de valida√ß√£o:
${z}`)}else((x=r.response)==null?void 0:x.status)===500?I.error("Erro interno do servidor. Tente novamente mais tarde."):r.message?I.error(`Erro: ${r.message}`):I.error("Erro ao salvar comiss√£o. Tente novamente.")}},o=>{console.error("‚ùå Erros de valida√ß√£o do formul√°rio:",o),console.log("üìã Dados atuais do formul√°rio:",R()),console.log("üîç Estado de valida√ß√£o:",{isValid:U,isSubmitting:W,isDirty:ue,segundoPassoValido:$,participantesData:C});const s=Object.entries(o).map(([a,i])=>`${a}: ${(i==null?void 0:i.message)||"Erro desconhecido"}`).join(", ");I.error(`Erros de valida√ß√£o: ${s}`)}),be=()=>e.jsxs(l,{spacing:4,children:[e.jsxs(B,{children:[e.jsx(p,{variant:"h5",sx:{color:"text.primary",fontWeight:700,mb:1},children:"Configura√ß√£o B√°sica"}),e.jsx(p,{variant:"body2",color:"text.secondary",children:"Defina as informa√ß√µes b√°sicas da regra de comiss√£o"})]}),e.jsx(L,{sx:{p:3},children:e.jsxs(l,{spacing:3,children:[e.jsx(T.Text,{name:"nome",label:"Nome da Regra",placeholder:"Ex: Comiss√£o Apartamentos",required:!0}),e.jsx(T.Text,{name:"descricao",label:"Descri√ß√£o",placeholder:"Descri√ß√£o opcional",multiline:!0,rows:3}),e.jsxs(T.Select,{name:"categoriaProduto",label:"Categoria do Produto",required:!0,children:[e.jsx(V,{value:"imovel",children:"Im√≥vel"}),e.jsx(V,{value:"terreno",children:"Terreno"}),e.jsx(V,{value:"empreendimento",children:"Empreendimento"})]}),e.jsxs(T.Select,{name:"produtoId",label:"Escolha o produto",required:!0,disabled:D,children:[e.jsx(V,{value:"",children:D?"Carregando produtos...":"Selecione um produto"}),!D&&!w&&M.map(o=>e.jsx(V,{value:o.id,children:o.nome},o.id)),!D&&w&&e.jsx(V,{value:"",disabled:!0,children:"Erro ao carregar produtos"}),!D&&!w&&M.length===0&&e.jsx(V,{value:"",disabled:!0,children:"Nenhum produto encontrado"})]}),w&&e.jsx(A,{severity:"error",sx:{mt:1},children:w}),e.jsx(T.Text,{name:"percentualVenda",label:"Percentual sobre Venda",type:"number",required:!0,InputProps:{endAdornment:e.jsx(oe,{position:"end",children:"%"})}})]})}),!J&&e.jsx(A,{severity:"info",children:"Preencha todos os campos obrigat√≥rios para continuar"})]}),je=()=>{var o;return e.jsxs(l,{spacing:4,children:[e.jsxs(B,{children:[e.jsx(p,{variant:"h5",sx:{color:"text.primary",fontWeight:700,mb:1},children:"Distribui√ß√£o de Comiss√µes"}),e.jsx(p,{variant:"body2",color:"text.secondary",children:"Configure como a comiss√£o ser√° distribu√≠da entre os participantes"})]}),e.jsx(L,{sx:{p:3,bgcolor:"background.neutral"},children:e.jsxs(l,{spacing:3,children:[e.jsxs(l,{spacing:1,children:[e.jsx(p,{variant:"subtitle1",sx:{fontWeight:600,color:"text.primary"},children:d("nome")||"Nome da Regra"}),e.jsx(p,{variant:"body2",color:"text.secondary",children:d("descricao")||"Sem descri√ß√£o"})]}),e.jsx(ee,{}),e.jsxs(l,{spacing:2,children:[e.jsxs(l,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(F,{icon:P==="imovel"?"mdi:home":P==="terreno"?"mdi:terrain":"mdi:city",sx:{color:"primary.main"}}),e.jsxs(l,{children:[e.jsx(p,{variant:"body2",sx:{fontWeight:500},children:P==="imovel"?"Im√≥vel":P==="terreno"?"Terreno":"Empreendimento"}),e.jsx(p,{variant:"caption",color:"text.secondary",children:"Categoria do produto"})]})]}),d("produtoId")&&e.jsxs(l,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(F,{icon:"mdi:tag",sx:{color:"info.main"}}),e.jsxs(l,{children:[e.jsx(p,{variant:"body2",sx:{fontWeight:500},children:((o=M.find(s=>s.id===d("produtoId")))==null?void 0:o.nome)||"Produto selecionado"}),e.jsx(p,{variant:"caption",color:"text.secondary",children:"Produto espec√≠fico"})]})]}),e.jsxs(l,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(F,{icon:"mdi:percent",sx:{color:"success.main"}}),e.jsxs(l,{children:[e.jsxs(p,{variant:"body2",sx:{fontWeight:500},children:[d("percentualVenda")||0,"% sobre a venda"]}),e.jsx(p,{variant:"caption",color:"text.secondary",children:"Percentual de comiss√£o"})]})]})]})]})}),e.jsx(l,{spacing:2,children:j.map((s,a)=>{const x=(d("participantes")||[]).map((r,b)=>({tipo:r==null?void 0:r.tipo,index:b})).filter(r=>r.tipo&&r.index!==a).map(r=>r.tipo);return e.jsx(L,{sx:{p:3},children:e.jsxs(l,{spacing:2,children:[e.jsxs(l,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(p,{variant:"subtitle2",children:["Participante ",a+1]}),e.jsx(we,{onClick:()=>{ge(a),u("")},color:"error",size:"small",children:e.jsx(F,{icon:"mingcute:delete-2-line"})})]}),e.jsxs(l,{direction:"row",spacing:2,children:[e.jsxs(T.Select,{name:`participantes.${a}.tipo`,label:"Tipo de Participante",sx:{flex:1},children:[e.jsx(V,{value:"",disabled:!0,children:"Selecionar tipo"}),re.map(r=>{const b=x.includes(r.value);return e.jsxs(V,{value:r.value,disabled:b,children:[r.label,b&&e.jsx(p,{component:"span",variant:"caption",color:"text.secondary",sx:{ml:1},children:"(j√° selecionado)"})]},r.value)})]}),e.jsx(T.Text,{name:`participantes.${a}.percentual`,label:"Percentual",type:"number",sx:{flex:1},InputProps:{endAdornment:e.jsx(oe,{position:"end",children:"%"})}})]})]})},s.id)})}),E&&e.jsx(A,{severity:"error",onClose:()=>u(""),children:E}),e.jsx(q,{onClick:fe,variant:"outlined",size:"large",startIcon:e.jsx(F,{icon:"mingcute:add-line"}),sx:{alignSelf:"center"},disabled:j.length>=6,children:"Adicionar Participante"}),j.length>=6&&!E&&e.jsx(A,{severity:"info",children:"Limite m√°ximo de 6 participantes atingido"}),y>100&&e.jsx(A,{severity:"error",children:"O total da distribui√ß√£o n√£o pode exceder 100%"}),y<100&&j.length>0&&e.jsxs(A,{severity:"warning",children:["Faltam ",(100-(typeof y=="number"?y:0)).toFixed(1),"% para completar a distribui√ß√£o"]}),Math.abs(y-100)<=.1&&y>0&&e.jsx(A,{severity:"success",children:"Distribui√ß√£o completa! ‚úì"})]})},ye=o=>{switch(o){case 0:return be();case 1:return je();default:return null}};return e.jsx(Ie,{methods:O,onSubmit:ve,children:e.jsxs(L,{children:[e.jsx(Ne,{title:c?"Editar Comiss√£o":"Nova Comiss√£o",subheader:"Configure as regras de distribui√ß√£o de comiss√£o",sx:{pb:3}}),e.jsx(ee,{}),e.jsxs(B,{sx:{p:3},children:[e.jsx(Fe,{activeStep:m,sx:{mb:4},children:te.map(o=>e.jsx(ze,{children:e.jsx(Le,{children:o})},o))}),ye(m),e.jsxs(l,{direction:"row",justifyContent:"space-between",sx:{mt:4},children:[e.jsx(q,{disabled:m===0,onClick:xe,variant:"outlined",size:"large",children:"Voltar"}),m===te.length-1?e.jsx(Te,{type:"submit",variant:"contained",size:"large",loading:W,disabled:!$,sx:{minWidth:120},onClick:()=>{console.log("üñ±Ô∏è Bot√£o Criar/Atualizar clicado!"),console.log("üîç Estado atual:",{segundoPassoValido:$,isSubmitting:W,activeStep:m,participantesData:C,isValid:U,errors:pe,percentualTotal:y,botaoHabilitado:$})},children:c?"Atualizar":"Criar"}):e.jsx(q,{onClick:he,variant:"contained",size:"large",disabled:!J,sx:{minWidth:120},children:"Pr√≥ximo"})]})]})]})})}export{Qe as C};

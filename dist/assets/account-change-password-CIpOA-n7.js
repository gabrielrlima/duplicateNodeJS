import{W as Q,r as p,y as C,z as I,O,a8 as D,a9 as E,cN as g,j as s,F as V,G as L,K as m,T as Y,dt as $,B as k,S as X,N as q,Q as u,Y as Z,a0 as G,a1 as P,I as w}from"./index-cNRh_qft.js";import{s as _}from"./schema-helper-D18en8Wv.js";import{C as T}from"./Card-C_-31fGp.js";const ee=O({displayName:u().min(1,{message:"Nome √© obrigat√≥rio!"}),lastName:u().min(1,{message:"Sobrenome √© obrigat√≥rio!"}),email:u().min(1,{message:"Email √© obrigat√≥rio!"}).email({message:"Email deve ser um endere√ßo v√°lido!"}),photoURL:_.file({required:!1}).optional()});function te(){const{user:e,checkUserSession:U}=Q();console.log("üîç AccountGeneral - Dados do usu√°rio (nova estrutura):",{user:e,timestamp:new Date().toISOString()});const r=p.useMemo(()=>({displayName:(e==null?void 0:e.firstName)||"Root User",lastName:(e==null?void 0:e.lastName)||"",email:(e==null?void 0:e.email)||"root@root.com",photoURL:e==null?void 0:e.photoURL}),[e]);console.log("üìã AccountGeneral - Valores mapeados (nova estrutura):",{displayName:r.displayName,email:r.email});const y={displayName:"",lastName:"",email:"",photoURL:null},f=C({mode:"all",resolver:I(ee),defaultValues:y,values:r}),{handleSubmit:N,watch:d,reset:x,formState:{isSubmitting:l}}=f,[B,S]=p.useState(!1),[J,K]=p.useState(0),[b,v]=p.useState(!1),W=(o,t)=>{const c=["displayName","lastName"];for(const h of c)if(o[h]!==t[h])return!0;const n=o.photoURL,A=t.photoURL;return n instanceof File||n!==A};p.useEffect(()=>{if(e&&!b){const o={displayName:e.firstName||"",lastName:e.lastName||"",email:e.email||"",photoURL:e.photoURL};console.log("üîÑ [AccountGeneral] Atualizando formul√°rio com dados do contexto:",{userData:o,previousUser:e,isUpdatingContext:b,timestamp:new Date().toISOString()}),x(o),S(!1),setTimeout(()=>{const t=d();console.log("‚úÖ [AccountGeneral] Verifica√ß√£o p√≥s-reset:",{currentValues:t,expectedValues:o,valuesMatch:JSON.stringify(t)===JSON.stringify(o)})},100)}},[e,x,b,d]),p.useEffect(()=>{const o=d(t=>{const c=W(t,r),n=t==null?void 0:t.photoURL;console.log("üì∏ [AccountGeneral] Estado do photoURL no watch:",{photoURL:n,photoURLType:typeof n,isFile:n instanceof File,fileName:n instanceof File?n.name:"N/A",fileSize:n instanceof File?n.size:"N/A",fileType:n instanceof File?n.type:"N/A"}),console.log("üîç [AccountGeneral] Verificando mudan√ßas:",{hasFormChanges:c,currentFormValues:t,currentUserData:r,timestamp:new Date().toISOString()}),S(c)});return()=>o.unsubscribe()},[d,r]);const H=N(async o=>{var c,n,A,h,F,z;const t=Date.now();console.log("üöÄ [AccountGeneral] Iniciando processo de atualiza√ß√£o:",{data:o,currentUser:e,timestamp:new Date().toISOString()});try{v(!0),S(!1),console.log("üì§ [AccountGeneral] Enviando dados para o backend..."),console.log("üì§ [AccountGeneral] Preparando FormData para envio...");const a=new FormData;a.append("firstName",o.displayName||""),a.append("lastName",o.lastName||""),console.log("üìù [AccountGeneral] Campos obrigat√≥rios adicionados:",{displayName:o.displayName});const R=o.photoURL instanceof File;if(console.log("üîç [AccountGeneral] Verificando tipo de photoURL:",{hasPhotoFile:R,photoURLType:typeof o.photoURL,photoURLConstructor:(n=(c=o.photoURL)==null?void 0:c.constructor)==null?void 0:n.name,photoURLSize:o.photoURL instanceof File?o.photoURL.size:"N/A",photoURLName:o.photoURL instanceof File?o.photoURL.name:"N/A",photoURLValue:o.photoURL,isFile:o.photoURL instanceof File,isString:typeof o.photoURL=="string",isNull:o.photoURL===null,isUndefined:o.photoURL===void 0}),R&&o.photoURL instanceof File&&(console.log("üìé [AccountGeneral] Adicionando arquivo:",{fileName:o.photoURL.name,fileSize:o.photoURL.size,fileType:o.photoURL.type}),a.append("photoURL",o.photoURL)),console.log("üì§ [AccountGeneral] Enviando FormData..."),R){console.log("üì§ [AccountGeneral] Enviando com arquivo via FormData...");const i=await D.patch(E.user.update,a,{headers:{}});console.log("‚úÖ [AccountGeneral] Upload com arquivo bem-sucedido:",i.data)}else{console.log("üì§ [AccountGeneral] Enviando sem arquivo via JSON...");const i={firstName:o.displayName||"",lastName:o.lastName||"",photoURL:(e==null?void 0:e.photoURL)||null};console.log("üìã [AccountGeneral] Dados JSON enviados:",i);const j=await D.patch(E.user.update,i);console.log("‚úÖ [AccountGeneral] Atualiza√ß√£o via JSON bem-sucedida:",j.data)}console.log("‚úÖ [AccountGeneral] Backend respondeu com sucesso"),g.success("Perfil atualizado com sucesso!");try{console.log("üîÑ [AccountGeneral] Atualizando sess√£o do usu√°rio...");const i=Date.now();await U(),console.log("‚úÖ [AccountGeneral] Sess√£o atualizada em:",Date.now()-i+"ms"),console.log("‚è≥ [AccountGeneral] Aguardando sincroniza√ß√£o do contexto..."),await new Promise(j=>setTimeout(j,500)),console.log("üìä [AccountGeneral] Dados do usu√°rio ap√≥s atualiza√ß√£o:",{user:e,hasUserData:!!e,userKeys:e?Object.keys(e):[],timestamp:new Date().toISOString()})}catch(i){console.warn("‚ö†Ô∏è [AccountGeneral] Erro ao atualizar sess√£o (perfil foi salvo):",i)}console.log("üîÑ [AccountGeneral] For√ßando re-render da interface..."),K(i=>i+1),console.log("üîì [AccountGeneral] Liberando atualiza√ß√£o do contexto..."),v(!1);const M=Date.now()-t;console.log("üéâ [AccountGeneral] Processo completo em:",M+"ms")}catch(a){console.error("‚ùå [AccountGeneral] Erro ao atualizar perfil:",a),(A=a==null?void 0:a.response)!=null&&A.status?g.error(`Erro ao atualizar perfil: ${((h=a.response.data)==null?void 0:h.message)||"Tente novamente."}`):(F=a==null?void 0:a.message)!=null&&F.includes("checkUserSession")||(z=a==null?void 0:a.message)!=null&&z.includes("auth")?(console.warn("‚ö†Ô∏è [AccountGeneral] Erro de autentica√ß√£o durante atualiza√ß√£o, mas perfil pode ter sido salvo"),g.success("Perfil atualizado! Fa√ßa login novamente se necess√°rio.")):g.error("Erro ao atualizar perfil. Tente novamente."),v(!1)}});return s.jsx(V,{methods:f,onSubmit:H,children:s.jsxs(L,{container:!0,spacing:3,children:[s.jsx(L,{size:{xs:12,md:4},children:s.jsx(T,{sx:{pt:10,pb:5,px:3,textAlign:"center"},children:s.jsx(m.UploadAvatar,{name:"photoURL",maxSize:2097152,helperText:s.jsxs(Y,{variant:"caption",sx:{mt:3,mx:"auto",display:"block",textAlign:"center",color:"text.disabled"},children:["Permitido *.jpeg, *.jpg, *.png, *.gif",s.jsx("br",{})," Tamanho m√°ximo de ",$(2097152)]})})})}),s.jsx(L,{size:{xs:12,md:8},children:s.jsxs(T,{sx:{p:3},children:[s.jsxs(k,{sx:{rowGap:3,columnGap:2,display:"grid",gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)"}},children:[s.jsx(m.Text,{name:"displayName",label:"Nome"}),s.jsx(m.Text,{name:"lastName",label:"Sobrenome"}),s.jsx(m.Text,{name:"email",label:"Email",disabled:!0,sx:{gridColumn:{xs:"1",sm:"1 / -1"}}})]}),s.jsx(X,{spacing:3,sx:{mt:3,alignItems:"flex-end"},children:s.jsx(q,{type:"submit",variant:"contained",loading:l,disabled:!B||l,sx:{minWidth:140,transition:"all 0.3s ease"},children:l?"Salvando...":"Salvar ajustes"})})]})})]})},J)}const oe=O({oldPassword:u().min(1,{message:"A senha √© obrigat√≥ria!"}).min(6,{message:"A senha deve ter pelo menos 6 caracteres!"}),newPassword:u().min(1,{message:"A nova senha √© obrigat√≥ria!"}),confirmNewPassword:u().min(1,{message:"A confirma√ß√£o da senha √© obrigat√≥ria!"})}).refine(e=>e.oldPassword!==e.newPassword,{message:"A nova senha deve ser diferente da senha antiga!",path:["newPassword"]}).refine(e=>e.newPassword===e.confirmNewPassword,{message:"As senhas n√£o coincidem!",path:["confirmNewPassword"]});function ie(){const e=Z(),U={oldPassword:"",newPassword:"",confirmNewPassword:""},r=C({mode:"all",resolver:I(oe),defaultValues:U}),{reset:y,handleSubmit:f,formState:{isSubmitting:N}}=r,d=f(async x=>{try{await new Promise(l=>setTimeout(l,500)),y(),g.success("Atualiza√ß√£o realizada com sucesso!"),console.info("DATA",x)}catch(l){console.error(l)}});return s.jsx(V,{methods:r,onSubmit:d,children:s.jsxs(T,{sx:{p:3,gap:3,display:"flex",flexDirection:"column"},children:[s.jsx(m.Text,{name:"oldPassword",type:e.value?"text":"password",label:"Senha antiga",slotProps:{input:{endAdornment:s.jsx(G,{position:"end",children:s.jsx(P,{onClick:e.onToggle,edge:"end",children:s.jsx(w,{icon:e.value?"solar:eye-bold":"solar:eye-closed-bold"})})})}}}),s.jsx(m.Text,{name:"newPassword",label:"Nova senha",type:e.value?"text":"password",slotProps:{input:{endAdornment:s.jsx(G,{position:"end",children:s.jsx(P,{onClick:e.onToggle,edge:"end",children:s.jsx(w,{icon:e.value?"solar:eye-bold":"solar:eye-closed-bold"})})})}},helperText:s.jsxs(k,{component:"span",sx:{gap:.5,display:"flex",alignItems:"center"},children:[s.jsx(w,{icon:"eva:info-fill",width:16})," A senha deve ter no m√≠nimo 6 caracteres"]})}),s.jsx(m.Text,{name:"confirmNewPassword",type:e.value?"text":"password",label:"Confirmar nova senha",slotProps:{input:{endAdornment:s.jsx(G,{position:"end",children:s.jsx(P,{onClick:e.onToggle,edge:"end",children:s.jsx(w,{icon:e.value?"solar:eye-bold":"solar:eye-closed-bold"})})})}}}),s.jsx(q,{type:"submit",variant:"contained",loading:N,sx:{ml:"auto"},children:"Salvar ajustes"})]})})}export{te as A,ie as a};
